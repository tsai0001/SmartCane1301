<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Force Cane Dashboard (JSON Event Mode)</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
  body { font-family: system-ui, sans-serif; margin: 18px; background:#f7f9fc; color:#111; }
  #chartWrap { background:#fff; padding:12px; border-radius:8px;
               box-shadow:0 6px 18px rgba(20,30,60,0.06);
               max-width:1100px; margin-bottom:20px; }
  .box { background:#fff; padding:12px; border-radius:8px;
         box-shadow:0 4px 12px rgba(20,30,60,0.05);
         max-width:1100px; margin-bottom:16px; }
  .title { font-size:1.1rem; font-weight:600; margin-bottom:6px; }
  .value { font-size:1rem; margin-bottom:4px; }
</style>
</head>
<body>

<h2>Force-Sensing Cane — JSON Event Dashboard</h2>

<div class="box">
  <div class="title">Latest Data Packet</div>
  <div id="latest"></div>
</div>

<div id="chartWrap">
  <canvas id="pressureChart" height="140"></canvas>
</div>



<script>
//* UPDATE THESE */
const PARTICLE_DEVICE_ID = "REPLACE_WITH_DEVICE_ID";
const PARTICLE_ACCESS_TOKEN = "REPLACE_WITH_ACCESS_TOKEN";

/* ---- Pressure vs Time Chart ---- */

const ctx = document.getElementById('pressureChart').getContext('2d');

const pressureChart = new Chart(ctx, {
  type: 'line',
  data: {
    labels: [],
    datasets: [{
      label: 'Pressure',
      data: [],
      borderWidth: 2,
      pointRadius: 0,
      tension: 0.2,
      borderColor: '#d62828',
      fill: false
    }]
  },
  options: {
    animation: false,
    scales: {
      x: { title: { display: true, text: 'Time' }},
      y: { title: { display: true, text: 'Pressure' }, beginAtZero: true }
    }
  }
});

const latestBox = document.getElementById("latest");
let packets = [];

let globalMaxPeak = 0;   // ⭐ NEW — tracks highest peak force recorded so far

/* ---- Event Stream ---- */

const streamURL =
  `https://api.particle.io/v1/devices/events/forcePacket?access_token=${PARTICLE_ACCESS_TOKEN}`;

const source = new EventSource(streamURL);

source.addEventListener("message", (evt) => {
  try {
    const wrapper = JSON.parse(evt.data);
    const json = JSON.parse(wrapper.data);

    const t = new Date();

    packets.push({
      t,
      peak: json.peak,
      steps: json.steps,
      pressure: json.pressure
    });

    /* ---- ⭐ Update Global Max Peak ---- */
    if (json.peak > globalMaxPeak) {
      globalMaxPeak = json.peak;
    }

    /* ---- Update HTML ---- */
    latestBox.innerHTML = `
      <div class="value">Time: ${t.toLocaleTimeString()}</div>
      <div class="value">Pressure: ${json.pressure.toFixed(2)}</div>
      <div class="value">Peak Force (latest packet): ${json.peak.toFixed(2)}</div>
      <div class="value" style="color:#d62828; font-weight:600;">
        Max Peak Force (session): ${globalMaxPeak.toFixed(2)}
      </div>
      <div class="value">Steps: ${json.steps}</div>
    `;

    /* ---- Update Chart ---- */
    pressureChart.data.labels.push(t.toLocaleTimeString());
    pressureChart.data.datasets[0].data.push(json.pressure);

    if (pressureChart.data.labels.length > 300) {
      pressureChart.data.labels.shift();
      pressureChart.data.datasets[0].data.shift();
    }

    pressureChart.update('none');

  } catch (err) {
    console.error("JSON parse error", err);
  }
});

/* ---------------------------------------------------------
   FAKE DATA MODE (for testing without Particle)
   --------------------------------------------------------- */

let USE_FAKE_DATA = true;   // ← turn off later by setting false

if (USE_FAKE_DATA) {
  console.log("FAKE DATA MODE ENABLED");

  setInterval(() => {
    const fake = {
      pressure: (Math.random() * 40 + 5),        // 5–45 N
      peak: (Math.random() * 60 + 20),           // 20–80 N
      steps: Math.floor(Math.random() * 20),     // 0–20 steps
      stepRate: (Math.random() * 1.5).toFixed(2) // Hz
    };

    const t = new Date();

    // Update latest display
    latestBox.innerHTML = `
      <div class="value">Time: ${t.toLocaleTimeString()}</div>
      <div class="value">Pressure: ${fake.pressure.toFixed(2)}</div>
      <div class="value">Peak Force: ${fake.peak.toFixed(2)}</div>
      <div class="value">Steps: ${fake.steps}</div>
      <div class="value">Step Rate: ${fake.stepRate} steps/sec</div>
    `;

    // Push to graph
    pressureChart.data.labels.push(t.toLocaleTimeString());
    pressureChart.data.datasets[0].data.push(fake.pressure);

    if (pressureChart.data.labels.length > 300) {
      pressureChart.data.labels.shift();
      pressureChart.data.datasets[0].data.shift();
    }

    pressureChart.update('none');

  }, 200); // update every 200 ms
}



</script>
</body>
</html>

